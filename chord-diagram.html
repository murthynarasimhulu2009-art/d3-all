<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chord Diagram</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  body {font-family: Arial, sans-serif;}
  .group-label {
    font-size: 12px;
    text-anchor: middle;
    pointer-events: none;
  }
</style>
</head>
<body>
<svg id="chord-diagram" width="500" height="500"></svg>
<script>
// Inline data
const rawData = [
  {"source":0,"target":1,"value":11975},
  {"source":0,"target":2,"value":5871},
  {"source":0,"target":3,"value":8916},
  {"source":1,"target":0,"value":1951},
  {"source":1,"target":2,"value":10048},
  {"source":1,"target":3,"value":2060},
  {"source":2,"target":0,"value":8010},
  {"source":2,"target":1,"value":16145},
  {"source":2,"target":3,"value":8090},
  {"source":3,"target":0,"value":1013},
  {"source":3,"target":1,"value":990},
  {"source":3,"target":2,"value":940}
];

// Determine number of nodes
const nodeSet = new Set();
rawData.forEach(d => { nodeSet.add(d.source); nodeSet.add(d.target); });
const n = nodeSet.size;

// Build matrix
const matrix = Array.from({length:n}, () => Array(n).fill(0));
rawData.forEach(d => {
  matrix[d.source][d.target] = d.value;
});

// Dimensions
const width = 500;
const height = 500;
const radius = Math.min(width, height) / 2 - 30;
const innerRadius = radius - 20;
const outerRadius = radius;

// Create SVG
const svg = d3.select('#chord-diagram')
  .attr('viewBox', `0 0 ${width} ${height}`)
  .append('g')
  .attr('transform', `translate(${width/2},${height/2})`);

// Color scale
const color = d3.scaleOrdinal(d3.schemeCategory10);

// Chord layout
const chord = d3.chord()
    .padAngle(0.05)
    .matrix(matrix);

// Arc generator for groups
const arc = d3.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius);

// Ribbon generator for chords
const ribbon = d3.ribbon()
    .radius(innerRadius);

// Draw chords (ribbons)
svg.append('g')
  .selectAll('path')
  .data(chord)
  .enter()
  .append('path')
    .attr('d', ribbon)
    .attr('fill', d => color(d.source.index))
    .attr('stroke', '#000')
    .attr('opacity', 0.7);

// Draw group arcs
const group = svg.append('g')
  .selectAll('g')
  .data(chord.groups)
  .enter()
  .append('g');

group.append('path')
    .attr('d', d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(outerRadius)
        .startAngle(d => d.startAngle)
        .endAngle(d => d.endAngle))
    .attr('fill', d => color(d.index))
    .attr('stroke', '#000')
    .attr('opacity', 0.8);

// Group labels
group.append('text')
    .attr('transform', function(d) {
        const angle = (d.startAngle + d.endAngle) / 2;
        const x = Math.cos(angle - Math.PI/2) * (outerRadius + 20);
        const y = Math.sin(angle - Math.PI/2) * (outerRadius + 20);
        const rotate = (angle * 180 / Math.PI) - 90;
        return `translate(${x},${y}) rotate(${rotate})`;
    })
    .attr('dx', d => ((d.startAngle + d.endAngle) / 2 > Math.PI ? -10 : 0))
    .attr('dy', '0.35em')
    .attr('text-anchor', d => ( (d.startAngle + d.endAngle) / 2 > Math.PI ? 'end' : 'start' ))
    .text(d => `Node ${d.index}`);

// Title
d3.select('body')
  .insert('h2', ':first-child')
  .text('Chord Diagram');

</script>
</body>
</html>