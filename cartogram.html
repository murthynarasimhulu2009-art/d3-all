<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cartogram</title>
<style>
  body { font-family: sans-serif; margin: 0; }
  .title { text-align: center; font-size: 24px; margin: 20px; }
  .tooltip {
    position: absolute;
    padding: 6px 12px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border-radius: 4px;
    pointer-events: none;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s;
  }
</style>
</head>
<body>
<div class="title">Cartogram</div>
<div id="chart"></div>
<div class="tooltip" id="tooltip"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<script>
(async function() {
  const width = 800, height = 500;

  const data = [
    { "state": "California", "value": 850000, "density": 245.3, "growth": 0.045 },
    { "state": "Texas", "value": 720000, "density": 189.7, "growth": 0.067 },
    { "state": "Florida", "value": 650000, "density": 312.8, "growth": 0.089 },
    { "state": "New York", "value": 580000, "density": 421.6, "growth": -0.012 },
    { "state": "Pennsylvania", "value": 490000, "density": 287.4, "growth": 0.023 },
    { "state": "Illinois", "value": 420000, "density": 231.9, "growth": -0.008 },
    { "state": "Ohio", "value": 380000, "density": 289.5, "growth": 0.015 },
    { "state": "Georgia", "value": 360000, "density": 178.2, "growth": 0.078 },
    { "state": "North Carolina", "value": 340000, "density": 206.7, "growth": 0.056 },
    { "state": "Michigan", "value": 320000, "density": 175.8, "growth": 0.034 }
  ];

  // Load US states GeoJSON (with "name" property)
  const geo = await d3.json('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json');

  // Create a map from state name to value
  const valueMap = new Map(data.map(d => [d.state, d.value]));

  // Merge data into GeoJSON
  geo.features.forEach(f => {
    const name = f.properties.name;
    f.properties.value = valueMap.get(name) || 0;
  });

  // Set up SVG
  const svg = d3.select('#chart')
    .append('svg')
    .attr('width', width)
    .attr('height', height);

  // Projection
  const projection = d3.geoAlbersUsa()
    .scale(1000)
    .translate([width / 2, height / 2]);

  const path = d3.geoPath().projection(projection);

  // Color scale
  const values = data.map(d => d.value);
  const color = d3.scaleSequential(d3.interpolateReds)
    .domain(d3.extent(values));

  // Tooltip
  const tooltip = d3.select('#tooltip');

  // Draw states
  svg.append('g')
    .selectAll('path')
    .data(geo.features)
    .enter()
    .append('path')
    .attr('d', path)
    .attr('fill', d => color(d.properties.value))
    .attr('stroke', 'white')
    .attr('stroke-width', 0.5)
    .on('mouseover', (event, d) => {
      const html = `<strong>${d.properties.name}</strong><br/>Value: ${d.properties.value}`;
      tooltip.html(html)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 28) + 'px')
        .style('opacity', 0.9);
      d3.select(event.currentTarget).attr('stroke', 'black').attr('stroke-width', 1.5);
    })
    .on('mouseout', (event) => {
      tooltip.style('opacity', 0);
      d3.select(event.currentTarget).attr('stroke', 'white').attr('stroke-width', 0.5);
    });

  // Legend
  const legendWidth = 200, legendHeight = 10;
  const legendData = d3.range(0,1.01,0.01);
  const legendScale = d3.scaleLinear()
    .domain([0,1])
    .range([0, legendWidth]);

  const legend = svg.append('g')
    .attr('transform', `translate(${width - legendWidth - 20},${height - 40})`);

  legend.selectAll('rect')
    .data(legendData)
    .enter()
    .append('rect')
    .attr('x', d => legendScale(d))
    .attr('y', 0)
    .attr('width', 2)
    .attr('height', legendHeight)
    .attr('fill', d => color(d3.min(values) + d * (d3.max(values) - d3.min(values))));

  // Axis labels for legend
  const legendScaleAxis = d3.scaleLinear()
    .domain(d3.extent(values))
    .range([0, legendWidth]);

  const axisBottom = d3.axisBottom(legendScaleAxis)
    .ticks(5)
    .tickSize(6);

  legend.append('g')
    .attr('transform', `translate(0,${legendHeight})`)
    .call(axisBottom);

})();
</script>
</body>
</html>