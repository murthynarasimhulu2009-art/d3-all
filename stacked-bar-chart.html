<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stacked Bar Chart</title>
  <style>
    body { font-family: sans-serif; }
    .axis path,
    .axis line {
      stroke: #000;
    }
    .title {
      text-anchor: middle;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <svg id="stacked-bar-chart" width="800" height="400"></svg>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    // Configuration
    const config = {
      "space": { "width": 800, "height": 400 },
      "margin": { "top": 50, "right": 50, "bottom": 50, "left": 50 },
      "data": [
        { "category": "A", "series1": 20, "series2": 30, "series3": 15 },
        { "category": "B", "series1": 35, "series2": 25, "series3": 20 },
        { "category": "C", "series1": 15, "series2": 40, "series3": 25 },
        { "category": "D", "series1": 30, "series2": 20, "series3": 30 }
      ],
      "keys": ["series1", "series2", "series3"],
      "colorScheme": d3.schemeCategory10
    };

    // Dimensions
    const width = config.space.width;
    const height = config.space.height;
    const { top, right, bottom, left } = config.margin;
    const innerWidth = width - left - right;
    const innerHeight = height - top - bottom;

    // Create SVG container
    const svg = d3.select('#stacked-bar-chart')
      .attr('width', width)
      .attr('height', height);

    // Title
    svg.append('text')
      .attr('class', 'title')
      .attr('x', width / 2)
      .attr('y', 30)
      .text('Stacked Bar Chart');

    // Main group
    const g = svg.append('g')
      .attr('transform', `translate(${left},${top})`);

    // X scale (band)
    const xScale = d3.scaleBand()
      .domain(config.data.map(d => d.category))
      .range([0, innerWidth])
      .padding(0.1);

    // Stack generator
    const stack = d3.stack()
      .keys(config.keys);

    const series = stack(config.data);

    // Y scale (linear) - compute max sum
    const maxY = d3.max(series, s => d3.max(s, d => d[1]));
    const yScale = d3.scaleLinear()
      .domain([0, maxY])
      .nice()
      .range([innerHeight, 0]);

    // Color scale
    const colorScale = d3.scaleOrdinal()
      .domain(config.keys)
      .range(config.colorScheme);

    // Render stacked bars
    const layer = g.selectAll('.serie')
      .data(series)
      .enter()
      .append('g')
      .attr('fill', d => colorScale(d.key));

    layer.selectAll('rect')
      .data(d => d.map(v => ({
        category: v.data.category,
        y0: v[0],
        y1: v[1],
        series: d.key
      })))
      .enter()
      .append('rect')
      .attr('x', d => xScale(d.category))
      .attr('y', d => yScale(d.y1))
      .attr('height', d => yScale(d.y0) - yScale(d.y1))
      .attr('width', xScale.bandwidth());

    // X Axis
    const xAxis = d3.axisBottom(xScale);
    g.append('g')
      .attr('class', 'axis')
      .attr('transform', `translate(0,${innerHeight})`)
      .call(xAxis);

    // Y Axis
    const yAxis = d3.axisLeft(yScale);
    g.append('g')
      .attr('class', 'axis')
      .call(yAxis);

    // Legend
    const legend = svg.append('g')
      .attr('transform', `translate(${width - right - 100},${top})`);

    const legendItem = legend.selectAll('.legend-item')
      .data(config.keys)
      .enter()
      .append('g')
      .attr('class', 'legend-item')
      .attr('transform', (d, i) => `translate(0,${i * 20})`);

    legendItem.append('rect')
      .attr('width', 18)
      .attr('height', 18)
      .attr('fill', d => colorScale(d));

    legendItem.append('text')
      .attr('x', 24)
      .attr('y', 14)
      .text(d => d);
  </script>
</body>
</html>